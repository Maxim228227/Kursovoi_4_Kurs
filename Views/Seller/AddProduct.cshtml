@model Kursovoi.Models.AddProductViewModel
@{
    ViewData["Title"] = "Добавить товар";
    var cats = ViewData["Categories"] as List<KeyValuePair<int,string>> ?? new List<KeyValuePair<int,string>>();
    var mans = ViewData["Manufacturers"] as List<KeyValuePair<int,string>> ?? new List<KeyValuePair<int,string>>();
    var storeId = ViewData["StoreId"] as int? ?? 0;
    var storeName = ViewData["StoreName"] as string ?? string.Empty;
    var storeOptions = ViewData["StoreOptions"] as List<KeyValuePair<int,string>>;
}

<h2>Добавить товар</h2>

@if (TempData["AddProductMsg"] != null)
{
    <div class="alert alert-success">@TempData["AddProductMsg"]</div>
}
@if (TempData["AddProductCsvReport"] != null)
{
    <div class="alert alert-info" style="white-space:pre-wrap;">@TempData["AddProductCsvReport"]</div>
}

<form method="post" enctype="multipart/form-data" class="mt-3">
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    @* include StoreId as hidden field and show store name or dropdown *@
    <input type="hidden" name="StoreId" value="@storeId" />
    <div class="mb-2">
        <label class="form-label">Магазин</label>
        @if (storeOptions != null && storeOptions.Count > 1)
        {
            <select name="StoreId" class="form-select" required>
                <option value="">-- Выберите магазин --</option>
                @foreach(var s in storeOptions) { <option value="@s.Key">@s.Value</option>; }
            </select>
        }
        else
        {
            <input class="form-control" value="@(string.IsNullOrEmpty(storeName) ? "(не привязан)" : storeName)" readonly />
        }
    </div>

    <div class="mb-2">
        <label class="form-label">Название товара</label>
        <input name="ProductName" class="form-control" value="@Model.ProductName" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Категория</label>
        <select name="CategoryId" class="form-select" required>
            <option value="">-- Выберите --</option>
            @foreach(var c in cats) { <option value="@c.Key">@c.Value</option>; }
        </select>
    </div>
    <div class="mb-2">
        <label class="form-label">Производитель</label>
        <select name="ManufacturerId" class="form-select" required>
            <option value="">-- Выберите --</option>
            @foreach(var m in mans) { <option value="@m.Key">@m.Value</option>; }
        </select>
    </div>
    <div class="mb-2">
        <label class="form-label">Краткое описание</label>
        <textarea name="Description" class="form-control">@Model.Description</textarea>
    </div>
    <div class="mb-2">
        <label class="form-label">Цена</label>
        <input name="Price" type="number" step="0.01" class="form-control" value="@Model.Price" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Скидка (например 0.15 или 15%)</label>
        <input name="Discount" step="0.01" type="number" class="form-control" value="@Model.Discount" />
    </div>
    <div class="mb-2">
        <label class="form-label">Начальный остаток</label>
        <input name="Quantity" type="number" class="form-control" value="@Model.Quantity" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Изображение товара</label>
        <input type="file" name="imageFile" accept="image/*" class="form-control" />
    </div>

    <div class="mt-3">
        <button class="btn btn-primary">Добавить</button>
        <a class="btn btn-link" href="@Url.Action("Index","Seller")">Отмена</a>
    </div>
</form>

<hr />

<h4>Загрузка CSV/Excel</h4>
<p>Описание полей и инструкции...</p>

<form method="post" asp-action="AddProductUpload" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" name="StoreId" value="@storeId" />
    <div class="mb-2">
        <label class="form-label">CSV-файл</label>
        <input type="file" name="csvFile" accept=".csv" class="form-control" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Дополнительные изображения (опционально)</label>
        <input type="file" name="images" accept="image/*" multiple class="form-control" />
    </div>
    <div>
        <button class="btn btn-secondary">Загрузить и добавить</button>
        <a class="btn btn-link" href="@Url.Action("Index","Seller")">Отмена</a>
    </div>
</form>

@section Scripts {
<script>
function safeStringify(obj) {
    var seen = new WeakSet();
    try {
        return JSON.stringify(obj, function(key, value) {
            if (value && typeof value === 'object') {
                if (seen.has(value)) return '[Circular]';
                seen.add(value);
            }
            // if value is an Error-like object convert to message
            if (value && typeof value === 'object' && (value.errorMessage || value.ErrorMessage || value.message || value.Message)) {
                return value.errorMessage || value.ErrorMessage || value.message || value.Message;
            }
            return value;
        }, 2);
    } catch (e) {
        try { return String(obj); } catch { return '[object Object]'; }
    }
}

function extractErrorTextFromObject(obj) {
    if (!obj) return '';
    if (typeof obj === 'string') return obj;
    if (typeof obj === 'object') {
        var candidates = ['errorMessage','ErrorMessage','message','Message','Description'];
        for (var i=0;i<candidates.length;i++){
            var k = candidates[i];
            if (obj[k]) return obj[k];
        }
        if (Array.isArray(obj.errors) && obj.errors.length>0) return obj.errors.join('\n');
        for (var key in obj) {
            if (!obj.hasOwnProperty(key)) continue;
            var v = obj[key];
            if (typeof v === 'string') return v;
            if (Array.isArray(v) && v.length>0 && typeof v[0] === 'string') return v.join('\n');
        }
        return safeStringify(obj);
    }
    return String(obj);
}

document.addEventListener('DOMContentLoaded', function(){
    var forms = document.querySelectorAll('form[method="post"][enctype="multipart/form-data"]');
    if (!forms || forms.length === 0) return;
    var form = forms[0];
    form.addEventListener('submit', function(e){
        e.preventDefault();
        var fd = new FormData(form);
        var tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        if (tokenInput && tokenInput.value) {
            fd.set('__RequestVerificationToken', tokenInput.value);
        }
        var submitBtn = form.querySelector('button[type="submit"], button');
        if (submitBtn) { submitBtn.disabled = true; }

        fetch(form.action || window.location.pathname, {
            method: 'POST',
            body: fd,
            credentials: 'same-origin',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(resp){
            if (!resp.ok) {
                return resp.text().then(function(t){ throw new Error('Server response ' + resp.status + '. ' + (t ? t.substring(0,1000) : '')); });
            }
            var ct = resp.headers.get('content-type') || '';
            if (ct.indexOf('application/json') === -1) {
                return resp.text().then(function(text){ try { return JSON.parse(text); } catch { throw new Error('Invalid JSON response from server. Response text: ' + (text ? text.substring(0,1000) : '(empty)')); } });
            }
            return resp.json();
        })
        .then(function(res){
            if (submitBtn) submitBtn.disabled = false;
            if (!res) { alert('Ошибка: пустой ответ'); return; }
            if (res.success) { alert('Товар добавлен'); window.location.href = '/Seller'; return; }
            if (res.errors) {
                var text = '';
                try {
                    Object.keys(res.errors).forEach(function(k){
                        var entry = res.errors[k];
                        if (Array.isArray(entry)) {
                            entry.forEach(function(msg){ text += (msg && typeof msg === 'object') ? extractErrorTextFromObject(msg) + '\n' : String(msg) + '\n'; });
                        } else if (typeof entry === 'string') {
                            text += entry + '\n';
                        } else if (entry && typeof entry === 'object') {
                            Object.values(entry).forEach(function(v){
                                if (Array.isArray(v)) v.forEach(function(msg){ text += (msg && typeof msg === 'object') ? extractErrorTextFromObject(msg) + '\n' : String(msg) + '\n'; });
                                else if (typeof v === 'string') text += v + '\n';
                                else if (v && typeof v === 'object') text += extractErrorTextFromObject(v) + '\n';
                            });
                        } else {
                            text += String(entry) + '\n';
                        }
                    });
                } catch (ex) { text = 'Ошибка разбора ошибок: ' + (ex && ex.message ? ex.message : ex); }
                alert('Ошибки:\n' + text);
                return;
            }
            if (res.error) { alert('Ошибка: ' + res.error); return; }
            alert('Неожиданный ответ: ' + safeStringify(res));
        })
        .catch(function(err){ if (submitBtn) submitBtn.disabled = false; alert('Ошибка: ' + (err && err.message ? err.message : 'network error')); });
    });
});
</script>
}