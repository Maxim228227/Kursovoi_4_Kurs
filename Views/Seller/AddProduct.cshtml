@model Kursovoi.Models.AddProductViewModel
@{
    ViewData["Title"] = "Добавить товар";
    var cats = ViewData["Categories"] as List<KeyValuePair<int,string>> ?? new List<KeyValuePair<int,string>>();
    var mans = ViewData["Manufacturers"] as List<KeyValuePair<int,string>> ?? new List<KeyValuePair<int,string>>();
    var storeId = ViewData["StoreId"] as int? ?? 0;
    var storeName = ViewData["StoreName"] as string ?? string.Empty;
}

<h2>Добавить товар</h2>

@if (TempData["AddProductMsg"] != null)
{
    <div class="alert alert-success">@TempData["AddProductMsg"]</div>
}
@if (TempData["AddProductCsvReport"] != null)
{
    <div class="alert alert-info" style="white-space:pre-wrap;">@TempData["AddProductCsvReport"]</div>
}

<form method="post" enctype="multipart/form-data" class="mt-3">
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    @* include StoreId as hidden field and show store name *@
    <input type="hidden" name="StoreId" value="@storeId" />
    <div class="mb-2">
        <label class="form-label">Магазин</label>
        <input class="form-control" value="@(string.IsNullOrEmpty(storeName) ? "(не привязан)" : storeName)" readonly />
    </div>

    <div class="mb-2">
        <label class="form-label">Название товара</label>
        <input name="ProductName" class="form-control" value="@Model.ProductName" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Категория</label>
        <select name="CategoryId" class="form-select" required>
            <option value="">-- выбрать --</option>
            @foreach(var c in cats) { <option value="@c.Key">@c.Value</option>; }
        </select>
    </div>
    <div class="mb-2">
        <label class="form-label">Производитель</label>
        <select name="ManufacturerId" class="form-select" required>
            <option value="">-- выбрать --</option>
            @foreach(var m in mans) { <option value="@m.Key">@m.Value</option>; }
        </select>
    </div>
    <div class="mb-2">
        <label class="form-label">Краткое описание</label>
        <textarea name="Description" class="form-control">@Model.Description</textarea>
    </div>
    <div class="mb-2">
        <label class="form-label">Цена</label>
        <input name="Price" type="number" step="0.01" class="form-control" value="@Model.Price" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Скидка (например 0.15 для 15%)</label>
        <input name="Discount" step="0.01" type="number" class="form-control" value="@Model.Discount" />
    </div>
    <div class="mb-2">
        <label class="form-label">Количество на складе</label>
        <input name="Quantity" type="number" class="form-control" value="@Model.Quantity" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Выберите фото с компьютера</label>
        <input type="file" name="imageFile" accept="image/*" class="form-control" />
    </div>

    <div class="mt-3">
        <button class="btn btn-primary">Добавить</button>
        <a class="btn btn-link" href="@Url.Action("Index","Seller")">Отмена</a>
    </div>
</form>

<hr />

<h4>Импорт через CSV/Excel</h4>
<p>Можно загрузить CSV файл с товарами. Файл должен быть в кодировке UTF-8. Столбцы в следующем порядке (без заголовка):</p>
<ol>
    <li><strong>ProductName</strong> — Название товара (строка)</li>
    <li><strong>CategoryId</strong> — Идентификатор категории (число) — используйте ID из таблицы категорий</li>
    <li><strong>ManufacturerId</strong> — Идентификатор производителя (число) — используйте ID производителя</li>
    <li><strong>Description</strong> — Краткое описание (строка)</li>
    <li><strong>Price</strong> — Цена, например 199.99</li>
    <li><strong>Discount</strong> — Скидка дробным числом, например 0.15 для 15% (можно 0)</li>
    <li><strong>Quantity</strong> — Количество на складе (целое число)</li>
    <li><strong>ImageFileName</strong> — Имя файла изображения (например <code>img1.jpg</code>) или полный путь в случае локальной загрузки. Если вы будете загружать изображения через форму ниже, указывайте только имя файла.</li>
</ol>
<p>Правила для изображений:</p>
<ul>
    <li>Вы можете загрузить изображения вместе с CSV: в форме ниже есть поле для выбора нескольких файлов.</li>
    <li>По каждому загруженному товару файл изображения будет скопирован в папку проекта: <code>C:\Users\seluz\source\repos\Kursovoi\Images</code></li>
    <li>Имя сохраняемого файла: <strong>&lt;Название магазина&gt;_&lt;Название товара&gt;.jpg</strong> — все пробелы заменяются на символ '_' и удаляются недопустимые символы. Расширение будет установлено в <code>.jpg</code>.</li>
    <li>Если исходный файл не найден среди загруженных файлов, товар будет создан без изображения.</li>
</ul>

<form method="post" asp-action="AddProductUpload" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" name="StoreId" value="@storeId" />
    <div class="mb-2">
        <label class="form-label">Выберите CSV-файл</label>
        <input type="file" name="csvFile" accept=".csv" class="form-control" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Загрузить изображения (несколько)</label>
        <input type="file" name="images" accept="image/*" multiple class="form-control" />
    </div>
    <div>
        <button class="btn btn-secondary">Загрузить и импортировать</button>
        <a class="btn btn-link" href="@Url.Action("Index","Seller")">Отмена</a>
    </div>
</form>