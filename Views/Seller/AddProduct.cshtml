@model Kursovoi.Models.AddProductViewModel
@{
    ViewData["Title"] = "Добавить товар";
    var cats = ViewData["Categories"] as List<KeyValuePair<int,string>> ?? new List<KeyValuePair<int,string>>();
    var mans = ViewData["Manufacturers"] as List<KeyValuePair<int,string>> ?? new List<KeyValuePair<int,string>>();
    var storeId = ViewData["StoreId"] as int? ?? 0;
    var storeName = ViewData["StoreName"] as string ?? string.Empty;
    var storeOptions = ViewData["StoreOptions"] as List<KeyValuePair<int,string>>;
}

<h2>Добавить товар</h2>

@if (TempData["AddProductMsg"] != null)
{
    <div class="alert alert-success">@TempData["AddProductMsg"]</div>
}
@if (TempData["AddProductCsvReport"] != null)
{
    <div class="alert alert-info" style="white-space:pre-wrap;">@TempData["AddProductCsvReport"]</div>
}

<form method="post" enctype="multipart/form-data" class="mt-3">
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    @* include StoreId as hidden field and show store name or dropdown *@
    <input type="hidden" name="StoreId" value="@storeId" />
    <div class="mb-2">
        <label class="form-label">Магазин</label>
        @if (storeOptions != null && storeOptions.Count > 1)
        {
            <select name="StoreId" class="form-select" required>
                <option value="">-- Выберите магазин --</option>
                @foreach(var s in storeOptions) { <option value="@s.Key">@s.Value</option>; }
            </select>
        }
        else
        {
            <input class="form-control" value="@(string.IsNullOrEmpty(storeName) ? "(не привязан)" : storeName)" readonly />
        }
    </div>

    <div class="mb-2">
        <label class="form-label">Название товара</label>
        <input name="ProductName" class="form-control" value="@Model.ProductName" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Категория</label>
        <select name="CategoryId" class="form-select" required>
            <option value="">-- Выберите --</option>
            @foreach(var c in cats) { <option value="@c.Key">@c.Value</option>; }
        </select>
    </div>
    <div class="mb-2">
        <label class="form-label">Производитель</label>
        <select name="ManufacturerId" class="form-select" required>
            <option value="">-- Выберите --</option>
            @foreach(var m in mans) { <option value="@m.Key">@m.Value</option>; }
        </select>
    </div>
    <div class="mb-2">
        <label class="form-label">Краткое описание</label>
        <textarea name="Description" class="form-control">@Model.Description</textarea>
    </div>
    <div class="mb-2">
        <label class="form-label">Цена</label>
        <input name="Price" type="number" step="0.01" class="form-control" value="@Model.Price" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Скидка (например 0.15 или 15%)</label>
        <input name="Discount" step="0.01" type="number" class="form-control" value="@Model.Discount" />
    </div>
    <div class="mb-2">
        <label class="form-label">Начальный остаток</label>
        <input name="Quantity" type="number" class="form-control" value="@Model.Quantity" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Изображение товара</label>
        <input type="file" name="imageFile" accept="image/*" class="form-control" />
    </div>

    <div class="mt-3">
        <button class="btn btn-primary">Добавить</button>
        <a class="btn btn-link" href="@Url.Action("Index","Seller")">Отмена</a>
    </div>
</form>

<hr />

<h4>Загрузка CSV/Excel</h4>
<p>Описание полей и инструкции...</p>

<form method="post" asp-action="AddProductUpload" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" name="StoreId" value="@storeId" />
    <div class="mb-2">
        <label class="form-label">CSV-файл</label>
        <input type="file" name="csvFile" accept=".csv" class="form-control" required />
    </div>
    <div class="mb-2">
        <label class="form-label">Дополнительные изображения (опционально)</label>
        <input type="file" name="images" accept="image/*" multiple class="form-control" />
    </div>
    <div>
        <button class="btn btn-secondary">Загрузить и добавить</button>
        <a class="btn btn-link" href="@Url.Action("Index","Seller")">Отмена</a>
    </div>
</form>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function(){
    var form = document.querySelector('form[method="post"][enctype="multipart/form-data"]');
    if (!form) return;
    form.addEventListener('submit', function(e){
        // if user has JS enabled, intercept and send via AJAX
        e.preventDefault();
        var fd = new FormData(form);
        var token = document.querySelector('form input[name="__RequestVerificationToken"]');
        if (token) fd.append('__RequestVerificationToken', token.value);
        var submitBtn = form.querySelector('button[type="submit"], button');
        if (submitBtn) { submitBtn.disabled = true; }
        fetch(form.action || window.location.pathname, { method: 'POST', body: fd, credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(function(r){ return r.json().catch(function(){ return { success: false, error: 'Invalid JSON response' }; }); })
            .then(function(res){
                if (submitBtn) submitBtn.disabled = false;
                if (!res) { alert('Ошибка сервера'); return; }
                if (res.success) {
                    alert('Товар добавлен');
                    window.location.href = '/Seller';
                    return;
                }
                // show validation errors
                if (res.errors) {
                    var text = '';
                    Object.keys(res.errors).forEach(function(k){ res.errors[k].forEach(function(msg){ text += msg + '\n'; }); });
                    alert('Ошибки:\n' + text);
                    return;
                }
                if (res.error) { alert('Ошибка: ' + res.error); }
            }).catch(function(){ if (submitBtn) submitBtn.disabled = false; alert('Сетевая ошибка'); });
    });
});
</script>
}