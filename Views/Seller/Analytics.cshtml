@model Kursovoi.Models.SellerAnalyticsViewModel
@{
    ViewData["Title"] = "Аналитика магазина";
}

<h1>Аналитика магазина</h1>

<div>
    <h3>Фильтры</h3>
    <form id="analyticsFilters" class="mb-4">
        <div class="row">
            <div class="col-md-4">
                <label for="startDate" class="form-label">Период с</label>
                <input type="date" id="startDate" name="startDate" class="form-control" />
            </div>
            <div class="col-md-4">
                <label for="endDate" class="form-label">по</label>
                <input type="date" id="endDate" name="endDate" class="form-control" />
            </div>
            <div class="col-md-4">
                <label for="category" class="form-label">Категория</label>
                <select id="category" name="category" class="form-select">
                    <option value="">Все категории</option>
                    @foreach (var category in ViewBag.Categories as List<KeyValuePair<int, string>>)
                    {
                        <option value="@category.Key">@category.Value</option>
                    }
                </select>
            </div>
        </div>
        <button type="button" id="applyFilters" class="btn btn-primary mt-3">Применить</button>
    </form>
</div>

<div>
    <h3>Графики</h3>
    <div class="row">
        <div class="col-md-6">
            <canvas id="ordersChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="stockChart"></canvas>
        </div>
    </div>
</div>

<div>
    <h3>На исходе</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Товар</th>
                <th>Кол-во</th>
                <th>Последнее обновление</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.RunningOutProducts)
            {
                <tr>
                    <td>@item.ProductName</td>
                    <td>@item.Quantity</td>
                    <td>@item.LastUpdate</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div>
    <h3>Заказы по дням</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Период</th>
                <th>Кол-во</th>
                <th>Сумма</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.OrdersByDay)
            {
                <tr>
                    <td>@item.Period</td>
                    <td>@item.OrderCount</td>
                    <td>@(item.TotalAmount.ToString("0.##") + " Br")</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div>
    <h3>Топ продаж</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Товар</th>
                <th>Продано</th>
                <th>Выручка</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.TopSellingProducts)
            {
                <tr>
                    <td>@item.ProductName</td>
                    <td>@item.QuantitySold</td>
                    <td>@(item.Revenue.ToString("0.##") + " Br")</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Server-side model data serialized to JS so charts render immediately without extra AJAX
        var initialOrders = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.OrdersByDay));
        var initialRunning = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RunningOutProducts));

        const ordersChartCtx = document.getElementById('ordersChart').getContext('2d');
        const stockChartCtx = document.getElementById('stockChart').getContext('2d');

        const ordersChart = new Chart(ordersChartCtx, {
            type: 'line',
            data: {
                labels: initialOrders.map(o => o.Period),
                datasets: [{
                    label: 'Заказы',
                    data: initialOrders.map(o => o.OrderCount),
                    borderColor: 'blue',
                    backgroundColor: 'rgba(0,0,255,0.05)',
                    fill: true
                }]
            },
            options: { responsive: true }
        });

        const stockChart = new Chart(stockChartCtx, {
            type: 'bar',
            data: {
                labels: initialRunning.map(p => p.ProductName),
                datasets: [{
                    label: 'Кол-во',
                    data: initialRunning.map(p => p.Quantity),
                    backgroundColor: 'orange'
                }]
            },
            options: { responsive: true }
        });

        document.getElementById('applyFilters').addEventListener('click', function () {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const category = document.getElementById('category').value || 0;

            fetch(`/Seller/GetSellerAnalytics?startDate=${encodeURIComponent(startDate)}&endDate=${encodeURIComponent(endDate)}&categoryId=${encodeURIComponent(category)}`, { credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' } })
                .then(response => response.json())
                .then(data => {
                    if (data && data.error) { alert('Ошибка: ' + data.error); return; }

                    // Update charts with returned data
                    ordersChart.data.labels = (data.OrdersByDay || []).map(o => o.Period);
                    ordersChart.data.datasets[0].data = (data.OrdersByDay || []).map(o => o.OrderCount);
                    ordersChart.update();

                    stockChart.data.labels = (data.RunningOutProducts || []).map(p => p.ProductName);
                    stockChart.data.datasets[0].data = (data.RunningOutProducts || []).map(p => p.Quantity);
                    stockChart.update();

                    // Optionally update tables by reloading the page or updating DOM here
                }).catch(function(err){ console.error(err); alert('Не удалось загрузить аналитику'); });
        });
    });
</script>
}